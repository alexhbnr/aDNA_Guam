# Overview of processing scripts

## Pre-processing of the data

  1. PREP_demultiplexSamples.Snakefile:
  
    De-multiplexes all sequencing runs with samples from either Flores or the
    Moluccas requiring perfect-index matching using an adapted version of
    Matthias' splitBAM script. Sequencing runs are checked whether they contain
    any sequencing data from a library id that is associated with these
    samples. A summary statistic regarding the number of retained reads per
    sample is stored.

  2. PREP_linkSamples.Snakefile:

    After de-multiplexing, the per-library BAM files are assigned to its sample
    and a symlink is created in the sample subfolder in the analysis folder
    following the naming scheme "{sample}-{lib}-{seqrun}.bam", in which the
    seqrun suffix refers to which sequencing run and lane the data was
    sequenced on.

  3. PREP_listSeqRuns.Snakefile:

    Specify which sequencing run contains capture data for which target, e.g.
    MT, 390K, 390Ksupp, or archaic admixture, and save it into a table.

  4. PREP_filterSamples.Snakefile:

    The per-lane BAM files are filtered for minimum length (35bp) and minimal
    mapping quality (MQ25), and duplicated sequences are removed. We use
    damageprofiler to determine both the length profile of the sequencing data
    and the observed amount of nucleotide substitutions compared to the
    reference genome. Finally, a separate sequencing data file is generated by
    keeping only reads with a C-T substitution in the terminal 3 bases of the
    already filtered reads. 

  5. PREP_mergeSamples.Snakefile:

    Merge all individual lanes of a sample that were either enriched for
    mitochondrial DNA or nuclear DNA (1240K, archaic admixture array) to a
    single BAM file for either mtDNA or nuclear DNA analysis.

  6. PREP_genotyping.Snakefile:

    The genotypes for the non-UDG treated sequencing data is generated using two
    methods, one that is regularly used at the MPI-SHH and one from the MPI-EVA,
    on the merged nuclear sequencing data using either all or deaminated-only
    DNA fragments. 

    In the MPI-SHH method, the genotypes are generated in a two-step approach
    adapted from Stephan Schiffels and Choonwong Jeong. In the first step, the
    aligned reads are trimmed for the terminal 10 bp on both the 5' and 3' end
    of the read and a genotype is determined using random-allele sampling. In
    the second step, random-allele sampling is performed on the non-trimmed
    reads, however, a genotype is only kept when it is a transversion with
    respect to the reference allele. The two genotype files are merged to a
    single genotype file.

    The MPI-EVA method is similar but instead of trimming all bases at the end
    of the reads, only masks the Ts on the forward and the As on the reverse
    strand by replacing them with Ns. These are the substitutions that might be
    caused by de-amination on a single-stranded library. After masking, we
    perform standard random read-sampling keeping all genotypes.

  7. PREP_captureArray_annotationfiles.Snakefile

    Copy the annotation files that contain the position of and the expected
    biallelic allele combination for each SNP on the capture array.

  8. PREP_annotate_genotypes.Snakefile

    The alleles obtained by random-allele sampling will be cross-checked
    against expected alleles at the variant sites of the capture array of
    interest. In order to have identical variant files for all analysis, the
    list of alternative alleles is subset to the one expected by the annotation
    file and samples that have an alternative genotype other than the expected
    one are set to missing. Sites absent in the genotyped samples but present in
    the annotation file are added to the VCF file by setting all samples to
    missing data. The annotated VCF files are finally converted to EIGENSTRAT
    format.

  9. PREP_autosomeContEst.Snakefile

    In order to have enough observations of reads aligning to the X chromosome,
    the sequencing data of a library is merged across all sequencing runs.

## Quality checks

  1. QUAL_sex.Snakefile

    Determine the sex of the individuals by determining the ratio of mean
    coverage along the X chromosome to the mean coverage along the autosomes
    for a subset of sites to which reads of length 35bp can be uniquely
    aligned. For females, the ratio is expected to be around 1.05 and for males
    half of this.

  2. QUAL_Xheterogeneity.Snakefile

    Estimate the contamination on the X chromosome for males by determining the
    amount of heterogeneity on the X chromsome using ANGSD.

  3. QUAL_yChr_haplogroup.Snakefile

    Subset the BAM files containing the reads aligning to the nuclear genome to
    the Y chromosome and run yHaplo with the deep tree search eanbled on it.

  4. QUAL_conditionalSubstitution.Snakefile

    Determine the contamination rate on the nuclear genome by estimating the
    number of reads that have a C>T substitution on the terminal base of the
    read and another C>T substitution on the last two positions at the other end
    of the read. The contamination rate can be estimated by calculating the
    ratio between all reads and the conditional substituted ones and
    substracting it from 1.

  5. QUAL_prepareMitoBench.Snakefile

    Link all per-library sequencing files that contain MT capture data into a
    separate directory and create config file for running the mitoBench ancient
    mtDNA pipeline. The pipeline is then started separately using the standard
    Snakefile and the project specific config file.

  6. QUAL_contamMix.Snakefile

    The libraries from Indonesia have a high amount of aDNA damage on the
    terminal bases of the read. When running contamMix with the untreated
    sequencing data, we might end up with an artificially inflated
    contamination estimate due to the high presence of C>T and G>A
    substitutions. In order to test, whether this is the case, I ran contamMix
    also against the sequencing data for which masked all Ts on the forward
    strand and all As on the reverse strand at the terminal ten bases of a
    read.

## Mitochondrial analysis

  1. MT_mitoBench.Snakefile

     Prepare config file for running the mitoBench ancient mtDNA pipeline based
     on the per-sample merged samples.

## Summary report

  1. SMRY_countOverlapArray.Snakefile

    For each nuclear array, 390K, 390Ksupplement, and archaic admixture, count
    the number of sites covered by each library using both all fragments or
    deaminated only.

  2. SMRY_libraries.Snakefile

    Summarise all results on a per-library basis regarding the read filtering,
    duplication rates, number of deaminated reads, number of SNPs covered of
    each SNP array of interest, and nuclear contamination estimates.

  3. SMRY_MT.Snakefile

    Combine the output of the mitoBench ancient-MT pipeline with the results of
    contamMix run on the sequencing data that was masked for terminal Ts on the
    forward and As on the reverse strand and generate a less detailed output
    file.

  4. SMRY_samples.Snakefile

    Calculate the overlap of the sites for which at least a single allele was
    observed for different SNP capture arrays.
